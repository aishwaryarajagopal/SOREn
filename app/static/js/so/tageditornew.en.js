"use strict";StackExchange.tagEditor=function(e,t,n){function i(){E=!0}function r(){if("undefined"==typeof D){for(var e=StackExchange.tagEditor.requiredTags,t=[],n=0;n<e.length;n++)t.push(e[n].Name.replace(/[.+]/g,"\\$&"));D=new RegExp("^(?:"+t.join("|")+")$")}return D}function o(){var e=StackExchange.tagEditor.requiredTags;if(e&&/^ ?$/.test(P.val())){var t=r();0===M.add(O).children().filter(function(){return t.test($(this).text())}).length&&b(StackExchange.tagEditor.requiredTags)}}function a(e,t){var n=window.tagRendererRaw(e,null,"span"),i=$(n);return t||(i.append($("<span>",{"class":"delete-tag","title":"remove this tag"})),A.trigger("tagSpanCreated",[i])),i}function s(){var e=M.find(".post-tag").map(function(e,t){return $(t).text()}).get().join(" ");e.length&&(e+=" ");var t=O.find(".post-tag").map(function(e,t){return $(t).text()}).get().join(" ");return t.length&&P.val().length&&(t=" "+t),{"text":e+P.val()+t,"lengthBeforeInput":e.length}}function l(){var e=P.val();return(""===e||" "===e)&&0===M.add(O).children().filter(function(){return!/^\s*$/.test($(this).text())}).length}function c(){var e=P.caret();if(M.add(O).find(".post-tag").length){var t=s();P.val(t.text),M.empty(),O.empty(),P.caret(e.start+t.lengthBeforeInput,e.end+t.lengthBeforeInput),S()}}function u(t){if(!j){var n;if(n=t?{"start":P.val().length,"end":P.val().length}:P.caret(),-1==n.start&&(n.start=n.end=0),n.start!==n.end)return c(),p(),void 0;var i=P.val().substr(0,n.start),r=P.val().substr(n.start),l=(i+"!").split(/[,;\s]+/);l[l.length-1]="!"===l[l.length-1]?"":l[l.length-1].slice(0,-1);var u=r.split(/[,;\s]+/),d=l.pop(),h=d.length;d+=u.shift(),l=sanitizeAndSplitTags(l.join(" ")),u=sanitizeAndSplitTags(u.join(" "));var f;for(f=0;f<l.length;f++)a(l[f]).appendTo(M);for(f=0;f<u.length;f++)a(u[f]).appendTo(O);d!==P.val()&&P.val(d);var g={};A.find(".post-tag").filter(function(){var e=$(this).text();return/^\s*$/.test(e)?!0:g[e]===!0?!0:(g[e]=!0,!1)}).remove();var m=s().text;m!=e.val()&&(e.val(m).trigger("change"),StackExchange.MarkdownEditor&&styleCode.updateLangdivDelayed.trigger(m.split(/ /g))),E&&(P.caret(h,h),w(),o()),p()}}function d(e,t){var n,i;if("string"==typeof e)i=e;else{if(!e.length)return;n=e,i=n.text()}for(var r=sanitizeAndSplitTags(P.val()),o=0;o<r.length;o++)a(r[o]).appendTo(M);if(P.val(i),n){var s=$($.unique(n.prevAll(".post-tag").get()));n.nextAll(".post-tag").prependTo(O),s.appendTo(M),n.remove()}else O.find(".post-tag").appendTo(M);P.focus(),t&&P.caret(0,0)}function h(e){var t=e.val(),n="c_"+t;if(n in B)return B[n];var i=$("<span />").css("font-family",e.css("font-family"));i.text(e.val()),i.insertAfter(e);var r=i.innerWidth();return i.remove(),B[n]=r,r}function f(e){e!==W&&(M.add(P).add(O).css({"position":"relative","left":e}),W=e)}function p(){var e=h(P)+19,t=M.outerWidth();return O.children().length||(e=Math.max(e,_-t-8)),P.css("width",e),t+W>0&&_>t+W+e?void 0:_>t+e?(f(0),void 0):(f(-t+(_-e)/2),void 0)}function g(){H=!0,setTimeout(function(){H=!1},0)}function m(e){if(e.shiftKey&&V[e.which]||e.ctrlKey&&65===e.which)return c(),!0;var t,n,i=P.caret().start,r=i===P.val().length,o=0===i;switch(e.which){case 37:return o?(d(M.find(".post-tag:last")),!1):!0;case 39:return r?(d(O.find(".post-tag:first"),!0),!1):!0;case 8:if(!o)return!0;if(t=M.find(".post-tag:last"),!t.length)return;return P.val(t.text()+P.val()),P.caret(t.text().length+i),t.remove(),!1;case 46:if(!r)return!0;if(n=O.find(".post-tag:first"),!n.length)return;return P.val(P.val()+n.text()),P.caret(i,i),n.remove(),!1;case 36:return t=M.find(".post-tag:first"),t.length?(d(t,!0),!1):!0;case 35:return n=O.find(".post-tag:last"),n.length?(d(n),!1):!0;case 40:return g(),$(".tag-suggestions > div:first").focus(),!1;case 9:g();break;case 27:S(),e.preventDefault(!0);break;case 13:if($(".tag-suggestions").length)return!1}return!0}function v(e){var t=e.find("p.more-info");"undefined"==typeof z&&(z=I-5-t.outerWidth());var n=e.find(".post-tag:first").outerWidth()+e.find(".item-multiplier").outerWidth();n>z&&t.find("a").text("info")}function b(e,t){$(".tag-suggestions").remove(),j=!1;var n=e.length;if(0!==n){var i=$("<div class='tag-suggestions' />").css({"position":"absolute","left":A.position().left,"top":A.position().top+L+1,"width":_-10}).insertAfter(A),r={};A.find(".post-tag").each(function(){r[$(this).text()]=!0});for(var o=0;o<e.length;o++)if(r[e[o].Name]!==!0){var a=y(e[o],t).appendTo(i).attr("tabindex",N||0);v(a),o%3===0&&a.css("clear","both")}i.delegate("div","keydown",C),i.delegate("div","click",function(e){$(e.target).is("a")||k($(this))}),i.delegate("div","focus",function(){H&&1===n?k($(this)):j=!0}),i.delegate("div","blur",function(){j=!1})}}function w(){var e=sanitizeAndSplitTags(P.val())[0];if(F!==e)return F=e,e&&e.length?(x(e,function(t){e===F&&E&&b(t,e)}),void 0):(S(),void 0)}function y(e,t){var n=$("<div />").css("width",I).data("tag-name",e.SynonymOf||e.Name);t&&(t=t.replace(/-/g,"").replace(/(.)(?=.)/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\."));var i=a(e.Name,!0),r=i.html();t&&(r=r.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),n.append(i.html(r)),e.Count&&n.append($("<span class='item-multiplier' />").html("&times;&nbsp;"+e.Count));var o="";if(e.Excerpt&&(o=e.Excerpt),o.length&&n.append($("<p />").text(o)),e.Synonyms&&e.Synonyms.length)for(var s=$("<p >also:</p>").appendTo(n),l=e.Synonyms.split(/\|/),c=0;c<l.length;c++)o=l[c],t&&(o=o.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),c>0&&(o=", "+o),s.append("<span>"+o+"</span>");return n.append("<p class='more-info'><a href='/tags/"+encodeURIComponent(e.SynonymOf||e.Name)+"/info' target='_blank'>learn more</a></p>"),n}function x(e,t){K["t_"+e]?t(K["t_"+e]):G.trigger(e,t)}function k(e){P.val(e.data("tag-name")),S(),d(""),u()}function S(){$(".tag-suggestions").remove(),j=!1,G.cancel()}function C(e){var t;switch(e.which){case 39:case 40:return $(this).next("div").focus(),!1;case 37:return $(this).prev("div").focus(),!1;case 38:return t=$(this).prev("div"),t.length?t.focus():P.focus(),!1;case 27:return S(),P.focus(),!1;case 13:case 32:return k($(this)),!1}}var E;if("undefined"==typeof n)try{E=e.is(":focus")}catch(T){E=!1}else E=n;if(e.bind("focus",i),!e.is(":visible"))return t=t||0,3>t?(setTimeout(function(){e.unbind("focus",i),StackExchange.tagEditor(e,t+1,E)},300),void 0):(e.unbind("focus",i),$("body.review-task-page").length||StackExchange.debug.log("tag box is invisible, couldn't start tag editor"),void 0);e.unbind("focus",i);var _=e.innerWidth(),I=(_-40)/3|0,A=$("<div class='tag-editor' />").css("width",_).insertAfter(e);e.hide();var R=$("<span class='post-tag'>test</span>").appendTo(A),L=A.innerHeight();R.remove(),A.css("height",L);var M=$("<span />").appendTo(A),P=$("<input type='text' tabIndex='0'/>").appendTo(A).val(e.val()+" "),O=$("<span />").appendTo(A),N=e.attr("tabIndex");N&&P.attr("tabIndex",N);var D,j=!1,U=E;P.focus(function(t,n){E=!0,o(),U||(n||e.triggerHandler("focus",!0),U=!0)});var q=!1;A.mousedown(function(){q=!0,$(document).one("mouseup",function(){setTimeout(function(){E||(e.triggerHandler("blur"),U=!1),q=!1},0)})}),P.blur(function(){E=!1,setTimeout(function(){j||(S(),u(),q||(e.triggerHandler("blur"),U=!1)),q=!1},0)}),e.focus(function(e,t){t||P.trigger("focus",!0)}),P.keydown(m),P.bind("keydown paste click change",function(){setTimeout(function(){u()},0)}),A.delegate(".post-tag","click",function(e){var t=$(this);$(e.target).hasClass("delete-tag")&&t.text(""),d(t),u()}),A.click(function(e){e.target===this&&(d(""),u())}),A.on("rerender",function(){c(),u(!0)});var H,F,z,B={},W=0,V={"35":!0,"36":!0,"37":!0,"38":!0,"39":!0,"40":!0},K={},G=StackExchange.helpers.DelayedReaction(function(e,t){StackExchange.helpers.addSpinner(A,{"position":"absolute","right":10,"top":L/2-2}),$.get("/filter/tags",{"q":e,"newstyle":!0},"json").done(function(n){K["t_"+e]=n,StackExchange.helpers.removeSpinner(),t(n)})},400,{"sliding":!0});u(!0),StackExchange.helpers.genericBindOverlayEvents(A,P,l),StackExchange.tagEditor.ready.resolve(),e[0].func_clear=function(){e.val(""),P.val("").blur(),A.find(".post-tag").remove()},e[0].func_add=function(e){var t=P.val();P.val(e),d(t),u()}},StackExchange.tagEditor.ready=$.Deferred();