{% extends "base.html" %}

{% block header_script %}
<link rel="stylesheet" href="{{ url_for('static', filename='bower_components/nvd3/nv.d3.css') }}">

<script type="text/javascript" src="{{ url_for('static', filename='bower_components/d3/d3.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='bower_components/nvd3/nv.d3.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/server_graph.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='bower_components/d3/d3.min.js') }}"></script>

<style type="text/css">
	#chart1, #chart2 {
		height: 350px;
	}
</style>

<script type="text/javascript">
	$(function(){
		$.ajax({
			url:"/trends/get-data",
			dataType: "json",
			success: function(data){
				drawViz(data, "#comparison-one");
			}
		});

		$.ajax({
			url: "/trends/get-data2",
			dataType: "json",
			success: function(data){
				drawViz(data, "#comparison-two");
			}
		})
	});

	//green swatch..
	//var seedHeatMapColors = ["#f7fcf5", '#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'];
	var seedHeatMapColors = ["#f7fbff", '#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'];

	var heatMapColors = d3.scale.linear()
	.domain(d3.range(0, 1, 1.0 / (seedHeatMapColors.length - 1)))
	.range(seedHeatMapColors);

	var heatMapRange = d3.scale.linear().domain([1, 15]).range([0,1]);

	function drawViz(data, selector){
		var svg = d3.select(selector);
		var itemHeight = 36;
		var yPadding = 100;
		var xPadding = 150;
		var width = 960;

		var main_visualization = svg.append("g").attr("class","main_visualization")
			.attr("transform", function(datum,index){
				var xTranslate = width/2 - ((xPadding + (itemHeight * data.row.length)/2));
				return "translate("+xTranslate+",0)";
			});

		var row_labels = main_visualization.append("g").attr("class","row_labels").attr("transform","translate(0,"+yPadding+")");
		var col_labels = main_visualization.append("g").attr("class","col_labels").attr("transform", "translate("+xPadding+",0)");
		var matrix = main_visualization.append("g").attr("class","matrix").attr("transform", "translate("+xPadding+","+yPadding+")");

		row_labels.selectAll(".row_labels").data(data.row).enter()
			.append("text")
			.attr("class","row_labels")
			.text(function(datum){
				return datum;
			})
			.attr("text-anchor", "end")
			.attr("x", xPadding-20)
			.attr("y", function(datum, index){
				return index*itemHeight + 25;
			})
			.attr("style", "fill: #000000;");

		col_labels.selectAll(".col_labels").data(data.col).enter()
			.append("g")
			.attr("class", "col_labels")
			.attr("transform", function(datum, index){
				return "translate("+(index* itemHeight + (itemHeight/2))+","+(yPadding-10)+")";
			})
			.each(function(datum, col_index){
				var g = d3.select(this);
				g.append("text")
				.text(function(datum){
					return datum
				})
				.attr("text-anchor","start")
				.attr("x", 0)
				.attr("y", 0)
				.attr("transform",function(datum){
					return "rotate(-50)";
				})
				.attr("style", "fill: #000000;");
			});

		matrix.selectAll(".rows")
			.data(data.values).enter()
			.append("g")
			.attr("class", "rows")
			.attr("transform", function(datum, index){
				return "translate(0,"+(index*itemHeight)+")";
			})
			.each(function(datum, row_index){

				var row = d3.select(this);

				row.selectAll(".items").data(datum).enter()
				.append("rect")
				.attr("class", "items")
				.attr("width", itemHeight)
				.attr("height", itemHeight)
				.attr("x", function(datum, index){
					return index*itemHeight;
				})
				.attr("y", 0)
				.attr("rx", 5)
				.attr("ry", 5)
				.attr("stroke-width","2px")
				.attr("style", function(datum){
					return "fill: "+heatMapColors(heatMapRange(datum))+"; stroke: #FFFFFF"
				});
			});
	}
</script>
{% endblock %}

{% block content %}
<div class="subheader">
	<h1 id="h-tags">Analyze Trends</h1>
	<!-- <div id="tabs">
		<a class="youarehere" href="/tags?tab=popular" title="most popular tags">popular</a>
		<a href="/tags?tab=name" title="tags in alphabetical order">name</a>
		<a href="/tags?tab=new" title="recently created tags">new</a>
	</div> -->
</div>

<div class="page-description">
	<p>
		The aim of the visualization is to depict trends in technology usage over time. With the StackOverflow dataset, we make an assumption that a technology is in use if people are asking questions pertaining to it.
	</p>
</div>

<h2 class="space">Server Side Scripting Technologies</h2>
<div>
	<svg id="chart1"></svg>
</div>

<h2 class="space">Database Technologies</h2>
<div>
	<svg id="chart2"></svg>
</div>

<h2 class="space">Front End Technologies vs Database Technologies</h2>
<div>
	<svg id="comparison-one" width="960" height="500"></svg>
</div>

<h2 class="space">Server Side Technologies vs Database Technologies</h2>
<div>
	<svg id="comparison-two" width="960" height="500"></svg>
</div>
{% endblock %}

{% block content_script %}
<script>
	var colors = d3.scale.category20();
	keyColor = function(d, i) {return colors(d.key)};

	var chart, chart2;
	nv.addGraph(function() {
		chart = nv.models.stackedAreaChart()
               //.width(600).height(500)
               .useInteractiveGuideline(true)
               .x(function(d) { return d[0] })
               .y(function(d) { return d[1] })
               .color(keyColor)
               .transitionDuration(300);
                //.clipEdge(true);

		// chart.stacked.scatter.clipVoronoi(false);

		chart.xAxis
		.tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

		chart.yAxis
		.tickFormat(d3.format(',.2f'));

		d3.select('#chart1')
		.datum(server_graph_json)
		.transition().duration(1000)
		.call(chart)
		    // .transition().duration(0)
		    .each('start', function() {
		    	setTimeout(function() {
		    		d3.selectAll('#chart1 *').each(function() {
		    			console.log('start',this.__transition__, this)
		              // while(this.__transition__)
		              if(this.__transition__)
		              	this.__transition__.duration = 1;
		          })
		    	}, 0)
		    });
		    // .each('end', function() {
		    //         d3.selectAll('#chart1 *').each(function() {
		    //           console.log('end', this.__transition__, this)
		    //           // while(this.__transition__)
		    //           if(this.__transition__)
		    //             this.__transition__.duration = 1;
		    //         })});

nv.utils.windowResize(chart.update);
	  		// chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
	  		return chart;
	  	});

nv.addGraph(function() {
	chart2 = nv.models.stackedAreaChart()
               //.width(600).height(500)
               .useInteractiveGuideline(true)
               .x(function(d) { return d[0] })
               .y(function(d) { return d[1] })
               .color(keyColor)
               .transitionDuration(300);
                //.clipEdge(true);

		// chart.stacked.scatter.clipVoronoi(false);

		chart2.xAxis
		.tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

		chart2.yAxis
		.tickFormat(d3.format(',.2f'));

		d3.select('#chart2')
		.datum(server_graph_json)
		.transition().duration(1000)
		.call(chart2)
		    // .transition().duration(0)
		    .each('start', function() {
		    	setTimeout(function() {
		    		d3.selectAll('#chart2 *').each(function() {
		    			console.log('start',this.__transition__, this)
		              // while(this.__transition__)
		              if(this.__transition__)
		              	this.__transition__.duration = 1;
		          })
		    	}, 0)
		    });
		    // .each('end', function() {
		    //         d3.selectAll('#chart1 *').each(function() {
		    //           console.log('end', this.__transition__, this)
		    //           // while(this.__transition__)
		    //           if(this.__transition__)
		    //             this.__transition__.duration = 1;
		    //         })});

nv.utils.windowResize(chart2.update);
	  		// chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
	  		return chart2;
	  	});
</script>
{% endblock %}